# Vercel + Neon PostgreSQL Deployment Guide

This project is fully configured for production deployment on Vercel with Neon PostgreSQL.

## Architecture Overview

- **Frontend**: React + TypeScript, built with Vite
- **Backend**: Express.js + TypeScript, runs as a Vercel Function
- **Database**: PostgreSQL on Neon (severless database)
- **ORM**: Drizzle ORM with postgres-js driver (optimized for serverless)
- **No local files**: All data stored in PostgreSQL, no SQLite or file-based databases

## Prerequisites

Before deploying, ensure you have:

1. A [Vercel account](https://vercel.com/signup)
2. A [Neon account](https://console.neon.tech) (free tier available)
3. Git repository with this code
4. Node.js 18+ installed locally

## Step 1: Create Neon PostgreSQL Database

1. Go to [console.neon.tech](https://console.neon.tech)
2. Click "Create a project" (or use existing)
3. Accept defaults or customize region/plan
4. Once created, go to "Connection string" tab
5. Copy the connection string that looks like:
   ```
   postgresql://user:password@region.neon.tech/database?sslmode=require
   ```

## Step 2: Test Locally

Before deploying to Vercel, test locally to ensure the connection works:

### Option A: Using Neon (Recommended)

1. Copy your Neon connection string
2. Update `.env` file:
   ```bash
   DATABASE_URL=postgresql://user:password@region.neon.tech/database?sslmode=require
   NODE_ENV=development
   PORT=5000
   ```
3. Run migrations:
   ```bash
   npm run db:push
   ```
4. Start development server:
   ```bash
   npm run dev
   ```
5. Verify database operations work

### Option B: Using Local PostgreSQL

1. Install PostgreSQL locally (see [POSTGRESQL_MIGRATION.md](./POSTGRESQL_MIGRATION.md))
2. Create a local database
3. Update `.env`:
   ```bash
   DATABASE_URL=postgresql://postgres:password@localhost:5432/aaharsevax
   NODE_ENV=development
   PORT=5000
   ```
4. Run migrations:
   ```bash
   npm run db:push
   ```
5. Start development server:
   ```bash
   npm run dev
   ```

## Step 3: Deploy to Vercel

### Option A: Using Vercel CLI (Recommended for Control)

1. Install Vercel CLI:
   ```bash
   npm install -g vercel
   ```

2. Login to Vercel:
   ```bash
   vercel login
   ```

3. Link your project:
   ```bash
   vercel link
   ```

4. Set environment variables:
   ```bash
   vercel env add DATABASE_URL
   # Paste your Neon connection string when prompted
   ```

5. Deploy:
   ```bash
   vercel --prod
   ```

### Option B: Connect GitHub to Vercel (Easiest)

1. Push your code to GitHub
2. Go to [vercel.com/new](https://vercel.com/new)
3. Import your GitHub repository
4. Configure environment variable:
   - Name: `DATABASE_URL`
   - Value: Your Neon connection string
5. Click "Deploy"

## Step 4: Verify Deployment

1. After deployment completes, open the provided URL
2. Test the following endpoints:
   ```bash
   # Get donations
   curl https://your-project.vercel.app/api/donations

   # Create donation
   curl -X POST https://your-project.vercel.app/api/donations \
     -H "Content-Type: application/json" \
     -d '{
       "donorName": "Test Donor",
       "contactNumber": "9876543210",
       "foodType": "Cooked",
       "quantity": "5kg",
       "city": "Mumbai"
     }'

   # Get NGO requests
   curl https://your-project.vercel.app/api/ngo-requests
   ```

3. Visit the app in browser to ensure React frontend loads

## Important Configuration Details

### DATABASE_URL Format

For Neon, your URL must include `?sslmode=require`:
```
postgresql://neon_user:password@region.neon.tech/aaharsevax?sslmode=require
```

The postgres-js driver automatically handles:
- SSL/TLS encryption (required by Neon)
- Connection pooling optimization for serverless
- Automatic reconnection on failures

### Vercel Configuration

The included `vercel.json` specifies:
- Build command: `npm run build`
- Output directory: `dist` (contains both API and static files)
- Development command: `npm run dev`
- Function memory: 1024 MB
- Max duration: 60 seconds per request

### Database Migrations

Migrations are stored in `./migrations/` directory (auto-generated by Drizzle Kit).

To apply schema changes in production:
1. Update `shared/schema.ts`
2. Run locally: `npm run db:push`
3. Test thoroughly
4. Push to GitHub
5. Vercel redeploys automatically (migrations already in repo)

## Troubleshooting

### Connection Refused

**Error**: `Error: Could not connect to database`

**Solution**:
- Verify DATABASE_URL is set in Vercel project settings
- Check DATABASE_URL format (must start with `postgresql://`)
- Ensure Neon database is active (check console.neon.tech)
- For Neon: Verify `?sslmode=require` is in the URL

### Migration Failed

**Error**: `Drizzle Kit Migration Error`

**Solution**:
1. Test locally first:
   ```bash
   npm run db:push
   ```
2. Verify DATABASE_URL points to correct database
3. Check Neon console for any database issues
4. Ensure schema.ts is valid TypeScript

### Serverless Function Timeout

**Error**: `Function timeout: function took longer than X seconds`

**Solution**:
- Increase timeout in vercel.json (max 60 seconds)
- Optimize queries for better performance
- Check database load
- Consider pagination for large datasets

### SSL Certificate Issues

**Error**: `SSL/TLS error` or `certificate verify failed`

**Solution**:
- postgres-js handles SSL automatically
- Ensure `?sslmode=require` is in DATABASE_URL for Neon
- No additional SSL certificates needed

## Development vs Production

### Local Development

```bash
# Set DATABASE_URL to local or Neon endpoint
# Run migrations
npm run db:push

# Start dev server with hot reload
npm run dev

# Server runs on localhost:5000
# Vite provides HMR for client
```

### Production (Vercel)

```bash
# DATABASE_URL set in Vercel environment variables
# Application deployed as serverless functions
# Static files served via CDN
# Automatic HTTPS/TLS
# Built-in monitoring and analytics
```

## Best Practices

### 1. Use Environment Variables

Never commit credentials. Always use:
- `.env` for local development (in .gitignore)
- Vercel project settings for production variables

### 2. Test Before Deploying

```bash
# Ensure local deployment works first
DATABASE_URL=your_neon_url npm run db:push
npm run dev

# Test API endpoints
curl http://localhost:5000/api/donations
```

### 3. Monitor Vercel Logs

```bash
# View real-time logs
vercel logs your-project-name

# View function logs
vercel functions list
```

### 4. Database Backup

Neon provides automatic backups. To export data:

1. Go to Neon console
2. Use their export/backup features
3. Or use standard PostgreSQL tools:
   ```bash
   pg_dump postgresql://user:password@host/db > backup.sql
   ```

### 5. Scale Database

As your app grows, upgrade Neon plan from free tier to paid:
- Neon free: 3GB storage, ideal for development
- Neon pro: Unlimited storage, better limits, recommended for production

## Rollback Strategy

If something breaks in production:

1. **Check Vercel Logs**: `vercel logs project-name`
2. **Rollback Code**: `vercel rollback`
3. **Rollback Database**: Contact Neon support or restore from backup
4. **Update DATABASE_URL**: If changing database, update in Vercel env vars

## Performance Optimization

For production-ready performance:

1. **Enable database query logging** (development only):
   ```typescript
   // In server/db.ts, add for debugging:
   console.log("Query:", params);
   ```

2. **Add response caching** (for non-sensitive data):
   ```typescript
   app.get("/api/donations", (req, res) => {
     res.set("Cache-Control", "public, max-age=60");
     // ... route handler
   });
   ```

3. **Implement rate limiting**:
   ```typescript
   import rateLimit from "express-rate-limit";

   const limiter = rateLimit({
     windowMs: 15 * 60 * 1000,
     max: 100
   });

   app.use("/api/", limiter);
   ```

## Useful Links

- [Vercel Documentation](https://vercel.com/docs)
- [Neon PostgreSQL](https://neon.tech)
- [Drizzle ORM PostgreSQL](https://orm.drizzle.team/docs/get-started-postgresql)
- [postgres-js](https://github.com/porsager/postgres)
- [Express.js on Vercel](https://vercel.com/guides/deploying-express-with-vercel)

## Support

If you encounter issues:

1. Check Vercel logs: `vercel logs [project-name]`
2. Check Neon status: https://status.neon.tech
3. Review this guide's troubleshooting section
4. Check Neon and Vercel documentation
5. Open an issue on GitHub if it's project-specific

---

**Remember**: Your project is now production-ready on Vercel with PostgreSQL. No local databases, no file-based storage, fully serverless-compatible.
